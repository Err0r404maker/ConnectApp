<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç API –ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–∞</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        button { padding: 10px 15px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background: #0056b3; }
        input, textarea { width: 100%; padding: 8px; margin: 5px 0; border: 1px solid #ddd; border-radius: 3px; }
        .result { background: #f8f9fa; padding: 10px; margin: 10px 0; border-radius: 3px; white-space: pre-wrap; }
        .error { background: #f8d7da; color: #721c24; }
        .success { background: #d4edda; color: #155724; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéì –¢–µ—Å—Ç API –ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–≥–æ –ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–∞</h1>
        
        <div class="section">
            <h2>1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞</h2>
            <button onclick="checkHealth()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å Health</button>
            <button onclick="getCSRF()">–ü–æ–ª—É—á–∏—Ç—å CSRF —Ç–æ–∫–µ–Ω</button>
            <div id="health-result" class="result"></div>
        </div>

        <div class="section">
            <h2>2. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
            <input type="email" id="reg-email" placeholder="Email" value="test@example.com">
            <input type="text" id="reg-username" placeholder="Username" value="testuser">
            <input type="text" id="reg-firstName" placeholder="–ò–º—è" value="–¢–µ—Å—Ç">
            <input type="text" id="reg-lastName" placeholder="–§–∞–º–∏–ª–∏—è" value="–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å">
            <input type="password" id="reg-password" placeholder="–ü–∞—Ä–æ–ª—å" value="password123">
            <select id="reg-role">
                <option value="STUDENT">–°—Ç—É–¥–µ–Ω—Ç</option>
                <option value="TEACHER">–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å</option>
            </select>
            <button onclick="register()">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
            <div id="register-result" class="result"></div>
        </div>

        <div class="section">
            <h2>3. –í—Ö–æ–¥</h2>
            <input type="email" id="login-email" placeholder="Email" value="test@example.com">
            <input type="password" id="login-password" placeholder="–ü–∞—Ä–æ–ª—å" value="password123">
            <button onclick="login()">–í–æ–π—Ç–∏</button>
            <div id="login-result" class="result"></div>
        </div>

        <div class="section">
            <h2>4. –ß–∞—Ç—ã</h2>
            <button onclick="getChats()">–ü–æ–ª—É—á–∏—Ç—å —á–∞—Ç—ã</button>
            <button onclick="createChat()">–°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π —á–∞—Ç</button>
            <div id="chats-result" class="result"></div>
        </div>

        <div class="section">
            <h2>5. –°–æ–æ–±—â–µ–Ω–∏—è</h2>
            <input type="text" id="message-content" placeholder="–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è" value="–ü—Ä–∏–≤–µ—Ç! –≠—Ç–æ —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ.">
            <button onclick="sendMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ</button>
            <div id="messages-result" class="result"></div>
        </div>
    </div>

    <script>
        let csrfToken = '';
        let accessToken = '';
        let currentChatId = '';
        
        const API_URL = 'http://localhost:3001/api';

        function showResult(elementId, data, isError = false) {
            const element = document.getElementById(elementId);
            element.textContent = JSON.stringify(data, null, 2);
            element.className = `result ${isError ? 'error' : 'success'}`;
        }

        async function makeRequest(url, options = {}) {
            try {
                const headers = {
                    'Content-Type': 'application/json',
                    ...options.headers
                };
                
                if (csrfToken && options.method !== 'GET') {
                    headers['X-CSRF-Token'] = csrfToken;
                }
                
                if (accessToken) {
                    headers['Authorization'] = `Bearer ${accessToken}`;
                }

                const response = await fetch(url, {
                    ...options,
                    headers
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || `HTTP ${response.status}`);
                }
                
                return data;
            } catch (error) {
                throw error;
            }
        }

        async function checkHealth() {
            try {
                const data = await makeRequest('http://localhost:3001/health');
                showResult('health-result', { status: '–°–µ—Ä–≤–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç!', ...data });
            } catch (error) {
                showResult('health-result', { error: error.message }, true);
            }
        }

        async function getCSRF() {
            try {
                const data = await makeRequest(`${API_URL}/csrf-token`);
                csrfToken = data.csrfToken;
                showResult('health-result', { message: 'CSRF —Ç–æ–∫–µ–Ω –ø–æ–ª—É—á–µ–Ω', token: csrfToken.substring(0, 20) + '...' });
            } catch (error) {
                showResult('health-result', { error: error.message }, true);
            }
        }

        async function register() {
            try {
                if (!csrfToken) await getCSRF();
                
                const data = await makeRequest(`${API_URL}/auth/register`, {
                    method: 'POST',
                    body: JSON.stringify({
                        email: document.getElementById('reg-email').value,
                        username: document.getElementById('reg-username').value,
                        firstName: document.getElementById('reg-firstName').value,
                        lastName: document.getElementById('reg-lastName').value,
                        password: document.getElementById('reg-password').value,
                        role: document.getElementById('reg-role').value
                    })
                });
                
                accessToken = data.accessToken;
                showResult('register-result', { message: '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!', user: data.user });
            } catch (error) {
                showResult('register-result', { error: error.message }, true);
            }
        }

        async function login() {
            try {
                if (!csrfToken) await getCSRF();
                
                const data = await makeRequest(`${API_URL}/auth/login`, {
                    method: 'POST',
                    body: JSON.stringify({
                        email: document.getElementById('login-email').value,
                        password: document.getElementById('login-password').value
                    })
                });
                
                accessToken = data.accessToken;
                showResult('login-result', { message: '–í—Ö–æ–¥ —É—Å–ø–µ—à–µ–Ω!', user: data.user });
            } catch (error) {
                showResult('login-result', { error: error.message }, true);
            }
        }

        async function getChats() {
            try {
                if (!accessToken) {
                    throw new Error('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É');
                }
                
                const data = await makeRequest(`${API_URL}/chats`);
                showResult('chats-result', { message: '–ß–∞—Ç—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã', chats: data });
            } catch (error) {
                showResult('chats-result', { error: error.message }, true);
            }
        }

        async function createChat() {
            try {
                if (!accessToken) {
                    throw new Error('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É');
                }
                
                if (!csrfToken) await getCSRF();
                
                const data = await makeRequest(`${API_URL}/chats`, {
                    method: 'POST',
                    body: JSON.stringify({
                        name: '–¢–µ—Å—Ç–æ–≤—ã–π —á–∞—Ç',
                        type: 'GROUP',
                        description: '–ß–∞—Ç –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏'
                    })
                });
                
                currentChatId = data.id;
                showResult('chats-result', { message: '–ß–∞—Ç —Å–æ–∑–¥–∞–Ω!', chat: data });
            } catch (error) {
                showResult('chats-result', { error: error.message }, true);
            }
        }

        async function sendMessage() {
            try {
                if (!accessToken) {
                    throw new Error('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É');
                }
                
                if (!currentChatId) {
                    throw new Error('–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ —á–∞—Ç');
                }
                
                if (!csrfToken) await getCSRF();
                
                const data = await makeRequest(`${API_URL}/messages`, {
                    method: 'POST',
                    body: JSON.stringify({
                        content: document.getElementById('message-content').value,
                        chatId: currentChatId,
                        type: 'TEXT'
                    })
                });
                
                showResult('messages-result', { message: '–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!', messageData: data });
            } catch (error) {
                showResult('messages-result', { error: error.message }, true);
            }
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–µ—Ä–≤–µ—Ä –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.onload = () => {
            checkHealth();
        };
    </script>
</body>
</html>